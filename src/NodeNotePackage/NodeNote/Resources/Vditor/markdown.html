<!DOCTYPE html>
<html lang="ch">
<meta charset="utf-8">
<head>

    <script src="./qwebchannel.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/vditor/dist/index.min.js"></script>

    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        
        html, body {
            height: 100%;
        }

        #vditor {
            height: 100%;
        }
    </style>
</head>


<body>
    <div id="vditor"></div>

    <script>
        // init vditor
        const initVditor = (language) => {
        window.vditor = new Vditor('vditor', {
            _lutePath: 'src/js/lute/lute.min.js',
            cdn: 'https://cdn.jsdelivr.net/npm/vditor',
            toolbar: [
                'upload',
                'record',
                'edit-mode',
                'content-theme',
                'code-theme',
                'export',
                'both',
                'preview',
                'info',
                'help'
            ],
            lang: language,
            mode: 'wysiwyg',
            outline: {
                enable: true,
                position: 'right',
            },
            debugger: true,
            typewriterMode: true,
            placeholder: 'Vditor MIT LICSENCE',
            preview: {
                markdown: {
                    toc: true,
                    mark: true,
                    footnotes: true,
                    autoSpace: true,
                },
                math: {
                    inlineDigit: true,
                    engine: 'KaTeX',
                },
                hljs: {
                    lineNumber: true,
                },
            },
            toolbarConfig: {
                pin: true,
            },
            counter: {
                enable: true,
                type: 'text',
            },
            hint: {
                emojiPath: 'https://cdn.jsdelivr.net/npm/vditor@3.8.10/dist/images/emoji',
                parse: false,
            },
            tab: '\t',
            upload: {
                accept: 'image/*,.mp3, .wav, .rar',
                token: 'test',
                url: '/api/upload/editor',
                linkToImgUrl: '/api/upload/fetch',
                filename (name) {
                    return name.replace(/[^(a-zA-Z0-9\u4e00-\u9fa5\.)]/g, '').
                    replace(/[\?\\/:|<>\*\[\]\(\)\$%\{\}@~]/g, '').
                    replace('/\\s/g', '')
                },
            },
        })
        }
        initVditor('zh_CN')
        window.setLang = (language) => {
            window.vditor.destroy()
            initVditor(language)
        }
    </script>

    <script>
        // channel between qt and js
        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.saveSignal = channel.objects.saveSignal;
            window.saveSignal.change_js_markdown_signal.connect(function (receive_markdown) {
                vditor.setValue(receive_markdown);
            });
        })

        function returnText (receive_id) {
            window.saveSignal.save_text(receive_id, vditor.getValue());
        }

    </script>
</body>
